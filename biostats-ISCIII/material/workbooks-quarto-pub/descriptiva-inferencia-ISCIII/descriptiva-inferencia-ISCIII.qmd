---
title: "Introducci칩n a la estad칤stica descriptiva e inferencia"
subtitle: "Cuadernos pr치cticos del M치ster de Bioinform치tica (curso 2024-2025)"
author: "Javier 츼lvarez Li칠bana"
format:
  html:
    theme: [default, style.scss]
    toc: true
    toc-title: 칈ndice
    toc-depth: 5
    toc-location: left
    number-sections: true
embed-resources: true
execute: 
  echo: true
---

## Estad칤stica descriptiva univariante


La estad칤stica descriptiva es una rama de la estad칤stica que se dedica a [**recolectar, organizar, presentar y analizar un conjunto de datos**]{.hl-yellow} para describir las caracter칤sticas y comportamientos de dicho conjunto.


Adem치s de para conocer y entender los datos es la fase en la que [**detectaremos errores e incongruencias**]{.hl-yellow}, teniendo muchas veces que hacer una [**depuraci칩n de datos**]{.hl-yellow} para dejar la base de datos preparada para su an치lisis.


### Etapas

#### Fase 1: recolecci칩n

La podemos hacer a trav칠s de **encuestas, experimentos, observaciones, registros**, etc. Lo m치s importante en esta etapa es que los datos sean representativos del fen칩meno o poblaci칩n que se estudia.


[**Ejemplo**]{.hl-green}: queremos llevar a cabo una [**investigaci칩n para analizar la satisfacci칩n de los pacientes**]{.hl-yellow} con los servicios de urgencias de la red de hospitales p칰blicos madrile침os. 쯈u칠 muestra ser치 m치s representativa?

a)  Los 100 primeros pacientes que lleguen a las urgencias del Hospital 12 de Octubre.

b)  Los 10 primeros pacientes que lleguen a las urgencias de todos los hospitales de la red de hospitales madrile침os.

c)  Seleccionamos al azar 3 hospitales del grupo 3 (hospitales de gran complejidad), grupo 2 (hospitales de complejidad intermedia) y grupo 3 (hospitales de baja complejidad) y de cada uno de ellos seleccionamos un n칰mero proporcional de pacientes seg칰n el n칰mero total de pacientes que llegan a cada hospital.


[**Soluci칩n**]{.hl-yellow}:

c)  **Seleccionamos al azar 3 hospitales del grupo 3 (hospitales de gran complejidad), grupo 2 (hospitales de complejidad intermedia) y grupo 3 (hospitales de baja complejidad) y de cada uno de ellos seleccionamos un n칰mero proporcional de pacientes seg칰n el n칰mero total de pacientes que llegan a cada hospital**.


Con a) todas las conclusiones que saquemos del estudio ser치n aplicadas al Hospital 12 de Octubre. Con b) es una forma semi representativa pero v치lida de conseguir una muestra de forma f치cil. La rama de la estad칤stica que se dedica a estudiar esta parte del an치lisis se conoce como [**muestreo**]{.hl-yellow}

#### Fase 2: organizaci칩n y presentaci칩n

Una vez recopilados los datos deben organizarse de manera que sean comprensibles y manejables. Para ello necesitaremos clasificar los datos en [**cuantitativos y cualitativos**]{.hl-yellow} y estudiar sus caracter칤sticas seg칰n su tipo.

-   [**Messy data**]{.hl-red}: datos mal organizados o desordenados (m칰ltiples individuos en cada fila, misma variable pero separada en varias columnas, etc).

-   [**Tidy data**]{.hl-green}: datos organizados y estandarizados (una variable en cada columna, un registro/individuo en cada fila y un solo valor en cada celda).

La informaci칩n la poder **resumir o presentar** de distintas maneras.

-   [**Estad칤sticos o medidas**]{.hl-yellow}:

    -   Medidas cualitativas: tablas de frecuencias.

    -   Medidas cuantitativas: medidas num칠ricas de centralizaci칩n y dispersi칩n.

-   [**Gr치ficamente**]{.hl-yellow}:

    -   Medidas cualitativas: gr치ficos de barras, gofres, etc.

    -   Medidas cuantitativas: histogramas, densidades, boxplots, etc

#### Fase 3: relaci칩n entre variables

Una vez hecho el estudio de cada variable por separado buscaremos [**relacionar dos variables de forma simult치nea para buscar la asociaci칩n**]{.hl-yellow} entre ellas:

-   [**Cuali vs cuali**]{.hl-yellow}: tablas de frecuencias --\> pruebas de Fisher y chi-cuadrado --\> interpretaci칩n de OR y RR.

-   [**Cuanti vs cuanti**]{.hl-yellow}: correlaci칩n --\> test de correlaciones (o test de igualdad de distribuciones) --\> diagrmas de dispersi칩n.

-   [**Cuanti vs cuali**]{.hl-yellow}: ANOVA, biserial correlation, etc.

### Conceptos b치sicos

En estad칤stica es fundamental entender los conceptos de [**poblaci칩n, muestra y variable**]{.hl-yellow}, ya que son la base para cualquier an치lisis estad칤stico.


-   [**Poblaci칩n**]{.hl-yellow}

La poblaci칩n es el **conjunto completo de elementos o individuos** que tienen una caracter칤stica com칰n y sobre los cuales se desea obtener informaci칩n. En la mayor칤a de casos el acceso a la **totalidad de la poblaci칩n es inviable** por motivos econ칩micos, legales o 칠ticos, as칤 que en la mayor칤a de situaciones las conclusiones deberemos sacarlas haciendo uso de lo que se conoce como **muestra**.


**Ejemplo**: la diferencia entre censo y encuesta es que el primero recopila datos de todos los individuos de una poblaci칩n, mientras que el segundo trata de estimarlos o inferirlos a partir de una muestra representativa de la misma.


-   [**Muestra**]{.hl-yellow}

Una muestra es un subconjunto de la poblaci칩n que se selecciona para su an치lisis con el fin de hacer inferencias o generalizaciones sobre la poblaci칩n completa. La muestra debe ser **representativa de la poblaci칩n** para que las conclusiones sean v치lidas.

#### Tipos de muestreo


-   **Muestreo aleatorio simple**: cada miembro de la poblaci칩n tiene la misma probabilidad de ser seleccionado.

-   **Muestreo estratificado**: la poblaci칩n se divide en subgrupos (estratos) y se toma una muestra de cada uno.

-   **Muestreo (no aleatorio) sistem치tico**: se selecciona cada n-칠simo miembro de la poblaci칩n.

-   **Muestreo (no aleatorio) por cuotas**: se seleccionan aquellos individuos que cumplan ciertas condiciones.

-   **Muestreo por conveniencia**: se elige a los miembros que son m치s f치ciles de acceder, aunque este m칠todo puede introducir sesgos.

&nbsp;

Veamos algunos ejemplos:

* [**Ejemplo 1**]{.hl-yellow}

  -   **Poblaci칩n**: todos los pacientes que han sido atendidos en un hospital espec칤fico durante el 칰ltimo a침o.

  -   **Muestra (aleatoria simple)**: Seleccionamosseleccionamos 200 pacientes de manera aleatoria del registro de pacientes del 칰ltimo a침o. Para asegurarnos de que la muestra sea representativa, podemos usar muestreo aleatorio simple, donde cada paciente tiene la misma probabilidad de ser seleccionado.


* [**Ejemplo 2**]{.hl-yellow}

  -   **Poblaci칩n**: todos los estudiantes matriculados en una universidad durante el semestre actual.

  -   **Muestra (aleatoria estratificada)**: seleccionamos 500 estudiantes utilizando muestreo estratificado para asegurar que diferentes subgrupos (estratos) de la poblaci칩n est칠n representados. Los estratos pueden ser facultades (mismo % de facultades representadas que en la poblaci칩n universitaria), g칠nero, clase social, etc.

* [**Ejemplo 3**]{.hl-yellow}

  -   **Poblaci칩n**: todas las especies de 치rboles en un bosque determinado.

  -   **Muestra (sistem치tica no aleatoria)**: Sseleccionamos parcelas de muestreo de 10m x 10m dentro del bosque y contabilizamos todas las especies de 치rboles presentes en esas parcelas. Esto se puede hacer utilizando muestreo sistem치tico.


* [**Ejemplo 4**]{.hl-yellow}

  -   **Poblaci칩n**: todos los pacientes de covid de un hospital.

  -   **Muestra (por cuotas no aleatoria)**: seleccionamos solo a las personas mayores de 65 a침os para realizar un estudio cl칤nico inicial sobre los efectos secundarios de una posible vacuna de la covid-19.

Estos m칠todos aseguran, de una manera u otra, que las muestras sean representativas de sus respectivas poblaciones, lo que permite realizar an치lisis precisos y confiables.

####  Tipos de variables

Una variable es **cualquier caracter칤stica o atributo** que puede tomar diferentes valores entre los individuos de la poblaci칩n o muestra. Las variables pueden ser de varios tipos seg칰n su naturaleza:

-   [**Cualitativas (o categ칩ricas)**]{.hl-purple}: describen cualidades o categor칤as. Ejemplos:

    -   Nominales: no tienen un orden intr칤nseco (e.g., g칠nero, estado civil).
    -   Ordinales: tienen un orden intr칤nseco (e.g., niveles de satisfacci칩n, grado acad칠mico, sano-leve-grave).


-   [**Cuantitativas**]{.hl-purple}: describen cantidades y pueden ser medidas num칠ricamente. Ejemplos:

    -   Discretas finitas: toman valores finitos (e.g., n칰mero de hijos, n칰mero de visitas al m칠dico, escala de dolor).
    -   Discretas infinitas: toman valores infinitos (o que se podr칤an considerar como tal) pero podemos enumerarlas y sabemos siempre el siguiente elemento (e.g., n칰mero de pelos de nuestra cabellera, n칰mero de personas que pueden entrar en una tienda en un periodo dado).
    -   Continuas: pueden tomar cualquier valor dentro de un rango (e.g., altura, peso, tiempo de espera).


-   [**Modalidades**]{.hl-yellow}

Una modalidad es uno de los **valores** que toma una **variable dentro de una muestra**.

El **conjunto de modalidades posibles** que podr칤a haber tomado (en tu poblaci칩n) se suele conocer tambi칠n como soporte. Algunos ejemplos en funci칩n del tipo de variables son:

  -   Color de ojos (cualitativa nominal): negro, azul y marr칩n (3 modalidades en esa muestra de un espectro de colores m치s amplio que podr칤amos tener como soporte).
  -   Estado del paciente (cualitativa ordinal): sano, leve y grave (3 modalidades en esa muestra de un conjunto de opciones - por ejemplo, sano, leve, grave, UCI, fallecido - que podr칤amos tener).


Una modalidad es uno de los valores que toma una variable dentro de una muestra. El **conjunto de modalidades** posibles que podr칤a haber tomado (en tu **poblaci칩n**) se suele conocer tambi칠n como **soporte**. Algunos ejemplos en funci칩n del tipo de variables son:

  -   N칰mero de hijos (cuantitativa discreta finita): 0, 1, 2 y 3 (4 modalidades en esa muestra de un conjunto de valores posibles - de 0 a...20 hijos - que podr칤amos tener en la poblaci칩n general).

  -   Temperatura anual de Madrid (cuantitativa continua): un rango de -5췈C a 45췈C (un rango continuo de valores en los que se mueve nuestra variable en la muestra (de un rango m치s amplio, por ejemplo desde -20췈C a 50췈C que podr칤a moverse de manera global si tuvi칠semos otra muestra).

Veamos algunos ejemplos: piensa en tipos de variables que se pueden medir en cada uno de los ejemplos de poblaci칩n y muestra que hemos estudiado.

* [**Ejemplo 1**]{.hl-yellow}

| Poblaci칩n                                                                                                              | Muestra                                                                                   | Variables                            |
|:--------------------------------------------------|:---------------------|:-------------------------------------|
| Todos los pacientes de un hospital de los queremos estudiar su grado de satisfcacci칩n con la atenci칩n que han recibido | 200 pacientes seleccionados de forma aleatoria del registro de pacientes en el 칰ltimo a침o | **Cuantitativas**: **Cualitativas**: |

* [**Ejemplo 1: soluci칩n**]{.hl-yellow}

| Poblaci칩n                                                                                                              | Muestra                                                                                   | Variables                                                                                                                                                                                                                                                                                                                           |     |
|:--------------------------------------------------|:---------------------|:------------------------------------------------|-----|
| Todos los pacientes de un hospital de los queremos estudiar su grado de satisfcacci칩n con la atenci칩n que han recibido | 200 pacientes seleccionados de forma aleatoria del registro de pacientes en el 칰ltimo a침o | **Cuantitativas**: edad (discreta), tiempo de espera (continua), grado de satisfacci칩n en una escala del 0 al 10 (discreta), n칰mero de visitas en el 칰ltimo a침o (discreta). \| **Cualitativas**: g칠nero (nominal), estado civil (nominal), si viene acompa침ado (nominal), grado de satisfacci칩n como bueno, regular malo (ordinal). |     |

* [**Ejemplo 2**]{.hl-yellow}

+--------------------------------------------+----------------------------------------------+--------------------+
| Poblaci칩n                                                                                                       | Muestra                                      | Variables          |
+:================================================================================================================+:=============================================+:===================+
| Todos los estudiantes matriculados en una universidad de los que queremos estudiar las calificaciones obtenidas | 500 estudiantes de las diferentes facultades | **Cuantitativas**: |
|                                                                                                                 |                                              |                    |
|                                                                                                                 |                                              | **Cualitativas**:  |
+--------------------------------------------+----------------------------------------------+--------------------+

* [**Ejemplo 2: soluci칩n**]{.hl-yellow}

| Poblaci칩n                                                                                                       | Muestra                                      | Variables                                                                                                                                                                   |
|:-------------------------------------------|:---------------------------------------------|:----------------------------------|
| Todos los estudiantes matriculados en una universidad de los que queremos estudiar las calificaciones obtenidas | 500 estudiantes de las diferentes facultades | **Cuantitativas**: calificaciones, edad (discreta), n칰mero de veces que se ha presentado al examen (discreta). **Cualitativas**: asignaturas (nominal), facultad (nominal). |

*  [**Ejemplo 3**]{.hl-yellow}

+-------------+------------------------------------------------------------------+--------------------+
| Poblaci칩n                                                                        | Muestra                                                          | Variables          |
+:=================================================================================+:=================================================================+:===================+
| Especies de 치rboles en un bosque de los que queremos estudiar su estado de salud | selecci칩n sistem치tica de parcelas de 10m x 10m dentro del bosque | **Cuantitativas**: |
|                                                                                  |                                                                  |                    |
|                                                                                  |                                                                  | **Cualitativas**:  |
+-------------+------------------------------------------------------------------+--------------------+

* [**Ejemplo 3: soluci칩n**]{.hl-yellow}

| Poblaci칩n                                                                        | Muestra                                                          | Variables                                                                                                                                                                                                    |
|:------------|:-----------------------------------------------------------------|:-------------------------------------------------------------------|
| Especies de 치rboles en un bosque de los que queremos estudiar su estado de salud | Selecci칩n sistem치tica de parcelas de 10m x 10m dentro del bosque | **Cuantitativas**: altura del 치rbol (continua), di치metro del 치rbol (continua), edad del 치rbol (discreta). **Cualitativas**: especie del 치rbol (nominal), estado de salud (ordinal), tipo de suelo (nominal). |

### Caracter칤sticas num칠ricas

Nos referimos a las medidas con las que se pretende resumir y condensar la informaci칩n contenida en un conjunto de datos. Las mayor칤a de caracter칤sticas num칠ricas las mediremos en variables cuantitativas.

#### Medidas de centralizaci칩n

Son los valores que resumen el conjunto de los datos de forma que reflejan el **centro de la distribuci칩n** de la tabla de frecuencias

##### Media

Es el [**valor medio o centro de gravedad**]{.hl-yellow} (el valor m치s cercano a todos los puntos a la vez). Es la suma de todos los valores dividida por el n칰mero total de valores.

$$\bar x= \frac{\sum^n_{i=1} x_i}{n}$$


* [**Ejemplo 1**]{.hl-yellow}

A los enfermeros de un centro de salud se les pregunta por el n췈 de hijos que tienen. Sus respuestas son 0,1,2,0,1,1,0,0,2,2,3. 쮺u치l es su media?

$n=11$

$\sum^n_{i=1} x_i = 0+1+2+0+1+1+0+0+2+2+3 = 12$

$\bar x= \frac{\sum^n_{i=1} x_i}{n} = \frac{12}{11} = 1.09$ hijos

```{r}
x <- c(0, 1, 2, 0, 1, 1, 0, 0, 2, 2, 3)
mean(x)
```

 *  [**Ejemplo 2**]{.hl-yellow}

A los enfermeros de un centro de salud se les pregunta por el n췈 de hijos que tienen. Sus respuestas son 0,1,2,0,1,1,0,0,2,2,3,10. 쮺u치l es su media?

$\bar x= \frac{\sum^n_{i=1} x_i}{n} = \frac{22}{12} = 1.83$ hijos

```{r}
x <- c(0, 1, 2, 0, 1, 1, 0, 0, 2, 2, 3, 10)
mean(x)
```

::: callout-warning
## Cuidado...

La media es una medida 칰til y ampliamente aplicada de la tendencia central, pero debe ser utilizada con precauci칩n en conjuntos de datos que contienen valores at칤picos o est치n distribuidos de manera asim칠trica.
:::

##### Mediana

Es el [**valor del medio SIEMPRE Y CUANDO ordenemos**]{.hl-yellow} los datos. Divide la distribuci칩n de frecuencias en dos partes.

Para calcularla debemos realizar los siguientes pasos:

1.  Ordenar los datos en orden creciente

2.  Seg칰n el n칰mero de observaciones (n):

    -   Si n es impar: La mediana es el valor que ocupa la posici칩n central

    -   Si n es par: La mediana es el promedio de los dos valores central

*  [**Ejemplo 1: variables cuantitativas (n칰mero impar)**]{.hl-yellow}

  -   Datos: 3, 1, 4, 2, 5 (n=5)

  -   Ordenados: 1, 2, 3, 4, 5

  -   Mediana: 3 (el tercer valor)

*  [**Ejemplo 2: variables cuantitativas (n칰mero par)**]{.hl-yellow}

  -   Datos: 7, 2, 4, 6 (n=4)

  -   Ordenados: 2, 4, 6, 7

  -   Mediana: (4 + 6) / 2 = 5

*  [**Ejemplo 3: variables cualitativas (ordinales)**]{.hl-yellow}


  -   Datos: "notable", "suspenso", "sobresaliente", "suspenso", "notable", "aprobado", "notable" (n=7).

  -   Ordenados: "suspenso", "suspenso", "aprobado", "notable", "notable", "notable", "sobresaliente".

  -   Mediana: "notable".

::: callout-tip
## Consejo

La mediana es especialmente 칰til en **distribuciones asim칠tricas** o cuando se quiere una medida de tendencia central que no sea afectada por valores extremadamente altos o bajos.
:::

*  [**Ejemplo 4**]{.hl-yellow}:

A los enfermeros de un centro de salud se les pregunta por el n췈 de hijos que tienen. Sus respuestas son 0,1,2,0,1,1,0,0,2,2,3. 쮺u치l es su mediana?

$n=11$

Ordenados: 0,0,0,0,1,1,1,2,2,2,3

Mediana: Posici칩n 6 = 1 hijo

```{r}
x <- c(0,1,2,0,1,1,0,0,2,2,3)

median(x)
```

*  [**Ejemplo 5**]{.hl-yellow}:

A los enfermeros de un centro de salud se les pregunta por el n췈 de hijos que tienen. Sus respuestas son 0,1,2,0,1,1,0,0,2,2,3,10. 쮺u치l es su mediana?

$n=12$

Ordenados: 0,0,0,0,1,1,1,2,2,2,3,10

Mediana: Posici칩n 6 y 7 = 1 +1 /2 = 1 hijo

```{r}
x <- c(0,1,2,0,1,1,0,0,2,2,3, 10)

median(x)
```

##### Moda

Es el valor que [**presenta la m치xima frecuencia**]{.hl-yellow} y se puede calcular para **todas las variables (tambi칠n) cualitativas**. Es m치s, es un valor que suele usarse en el an치lisis de variables cualitativas.

1.  Unimodal:

    -   Datos: "negro", "negro", "amarillo", "verde", "amarillo", "negro"
    -   Moda: "negro" (aparece 3 veces, m치s que cualquier otro valor)

2.  Bimodal:

    -   Datos: 1, 2, 3, 3, 4, 4, 5
    -   Modas: 3 y 4 (ambos aparecen dos veces)

3.  Multimodal:

    -   Datos: 2, 2, 3, 3, 4, 4, 5, 5
    -   Modas: 2, 3, 4, y 5 (todos aparecen dos veces)

4.  Sin moda:

    -   Datos: 1, 2, 3, 4, 5
    -   Moda: No hay moda (todos los valores aparecen solo una vez)

*  [**Ejemplo 1**]{.hl-yellow}:


A los enfermeros de un centro de salud se les pregunta por el n췈 de hijos que tienen. Sus respuestas son 0,1,2,0,1,1,0,0,2,2,3. 쮺u치l es su moda?

```{r}
#| code-fold: true
library(tidyverse)
datos <- tibble("x" = c(0,1,2,0,1,1,0,0,2,2,3))

datos |>
  count(x)
```

La modalidad m치s frecuente es 0 por lo que la moda es 0.

#### Medidas de posici칩n: cuantiles

Los [**cuantiles son valores que dividen un conjunto de datos en partes iguales**]{.hl-yellow} seg칰n la distribuci칩n de los datos (de nuevo asumiento que tenemos los datos ordenados de menor a mayor). Los cuantiles son 칰tiles para comprender la distribuci칩n y la dispersi칩n de los datos. Existen diferentes tipos de cuantiles, cada uno con un n칰mero espec칤fico de divisiones:



1.  [**Cuartiles**]{.hl-yellow}: dividen el conjunto de datos en cuatro partes iguales.

    -   Primer cuartil (Q1): divide el 25% inferior de los datos del 75% superior.

    -   Mediana (Q2): divide el 50% inferior del 50% superior. Es el segundo cuartil.

    -   Tercer cuartil (Q3): divide el 75% inferior del 25% superior.

2.  [**Deciles**]{.hl-yellow}: dividen el conjunto de datos en diez partes iguales.

    -   Primer decil (D1): divide el 10% inferior del 90% superior.

    -   Segundo decil (D2): divide el 20% inferior del 80% superior.

    -   Y as칤 sucesivamente hasta el noveno decil (D9), que divide el 90% inferior del 10% superior.


3.  [**Percentiles**]{.hl-yellow}: dividen el conjunto de datos en cien partes iguales.

    -   Percentil 1 (P1): divide el 1% inferior del 99% superior.

    -   Percentil 2 (P2): divide el 2% inferior del 98% superior.

    -   Y as칤 sucesivamente hasta el percentil 99 (P99), que divide el 99% inferior del 1% superior.

*  [**Ejemplo 1**]{.hl-yellow}:

Supongamos que tenemos el siguiente conjunto de datos (que podemos ordenar): 10, 25, 4, 2, 14, 6, 18, 16, 8, 12, 20. 쮺u치les son sus cuartiles?

```{r}
#| code-fold: true
datos <- tibble("x" = c(10, 25, 4, 2, 14, 6, 18, 16, 8, 12, 20))

datos |> 
  reframe("cuartiles" = quantile(x))
```

#### Medidas de dispersi칩n

Medidas (solo disponibles para cuantitativas) que nos indican [**c칩mo de lejos o cerca est치n las observaciones del valor central**]{.hl-yellow} que hemos calculado, es decir cu치nto se alejan de la media o mediana: nos indican el grado de dispersi칩n de la distribuci칩n de frecuencias.

##### Recorrido o rango

Indica la diferencia entre el valor m치ximo y el valor m칤nimo en un conjunto de datos.

* [**Ejemplo 1**]{.hl-yellow}

A los enfermeros de un centro de salud se les pregunta por el n췈 de hijos que tienen. Sus respuestas son 0,1,2,0,1,1,0,0,2,2,3. 쮺u치l es su recorrido?

-   Valor m치ximo = 3

-   Valor m칤nimo = 0

-   Recorrido= 3-0 = 3

```{r}
x <- c(0,1,2,0,1,1,0,0,2,2,3)
max(x)- min(x)
```

*  [**Ejemplo 2**]{.hl-yellow}

A los enfermeros de un centro de salud se les pregunta por el n췈 de hijos que tienen. Sus respuestas son 0,1,2,0,1,1,0,0,2,2,3,10. 쮺u치l es su recorrido?

-   Valor m치ximo = 10

-   Valor m칤nimo = 0

-   Recorrido= 10-0 = 10

```{r}
x <- c(0,1,2,0,1,1,0,0,2,2,3, 10)
max(x) - min(x)
```

::: callout-warning
## Cuidado...

El recorrido es 칰til cuando se necesita una medida r치pida y simple de la dispersi칩n, pero para an치lisis m치s detallados y robustos, se utilizan otras medidas de dispersi칩n como la desviaci칩n est치ndar, la varianza o el rango intercuart칤lico.
:::

##### Rango Intercuat칤lico (IQR)

Mide la [**amplitud del 50% central de un conjunto de datos**]{.hl-yellow}. Se calcula como la diferencia entre el tercer cuartil (Q3) y el primer cuartil (Q1), proporcionando una medida robusta de la variabilidad de los datos al no ser afectada por valores at칤picos o extremos.

$$IQR = Q_3 - Q_1$$

##### Varianza

Cuantifica [**cu치nto var칤an los datos respecto a la media**]{.hl-yellow} del conjunto. Una varianza alta indica que los datos est치n m치s dispersos alrededor de la media, mientras que una varianza baja indica que los datos est치n m치s agrupados cerca de la media. [**Importante**]{.hl-green}: medimos las desviaciones al cuadrado para que no se cancelen signos.

$$s^2 = \frac{\sum_{i=1}^n (x_i - \bar x)^2}{n-1}$$

-   $x_i$ representa cada valor individual en el conjunto de datos.

-   $\bar x$ es la media de la muestra.

-   $n$ es el tama침o de la muestra.

##### Desviaci칩n t칤pica

Es la ra칤z cuadrada de la varianza y se calcula de la siguiente manera:

$$s = \sqrt {s^2} = \sqrt {\frac{\sum_{i=1}^n (x_i - \bar x)^2}{n-1}}$$

La [**desviaci칩n est치ndar**]{.hl-yellow} se interpreta en las mismas unidades que los datos originales, lo que la hace m치s intuitiva que la varianza. Indica la dispersi칩n promedio de los datos respecto a la media. F칤jate que en las **medidas de dispersi칩n el promedio lo estamos realizando diviendo entre n-1 y no entre n**. Esto es debido a que los par치metros que hemos visto hasta ahora se conocen con un apellido: [**par치metros muestrales**]{.hl-yellow} (calculados con los datos disponibles en una muestra).

El objetivo con ellos es aproximar los [**verdaderos par치metros poblacionales**]{.hl-yellow} (la media real de la poblaci칩n, no la que calculas con tu tabla), y el mejor estimador posible de la varianza poblaci칩n (se conoce como estimador insesgado, sin sesgo) es la que hemos definido dividiendo entre n-1, de ah칤 que todos los softwares estad칤sticos nos calculen dicho valor (se la conoce tambi칠n como cuasivarianza).

* [**Ejemplo 1**]{.hl-yellow}

A los enfermeros de un centro de salud se les pregunta por el n췈 de hijos que tienen. Sus respuestas son 0,1,2,0,1,1,0,0,2,2,3. 쮺u치l es su varianza y desviaci칩n t칤pica?

```{r}
x <- c(0,1,2,0,1,1,0,0,2,2,3)

var(x)
sd(x)
```

* [**Ejemplo 2**]{.hl-yellow}

A los enfermeros de un centro de salud se les pregunta por el n췈 de hijos que tienen. Sus respuestas son 0,1,2,0,1,1,0,0,2,2,3,10. 쮺u치l es su varianza y desviaci칩n t칤pica?

```{r}
x <- c(0,1,2,0,1,1,0,0,2,2,3, 10)

var(x)
sd(x)
```

##### Coeficiente de variaci칩n

Uno de los problemas al [**comparar dispersiones**]{.hl-yellow} de dos variables diferentes es que tanto la varianza como la desviaci칩n t칤pica [**dependen de la escala de los datos**]{.hl-red}.

Esto implica que una desviaci칩n de, por ejemplo, 0.5, puede representar una dispersi칩n peque침a (si el rango de mis datos est치 entre 100 y 200, por ejemplo) pero puede representar una dispersi칩n enorme si el rango de mis datos es tambi칠n peque침o (por ejemplo, datos entre 0 y 1).

Para poder comparar dispersiones de variables de diferentes rangos (o incluso unidades) existe el conocido como coeficiente de variaci칩n (CV):

$$CV = \frac s {|\bar x|}$$

El **coeficiente de variaci칩n es siempre adimensional y positivo**.


### Tablas de frecuencias

Las variables cualitativas o cuantitativas discretas las vamos a poder [**resumir en tablas de frecuencias o de contigencia**]{.hl-yellow} donde se ordenan y estructuran los valores de una variable x de forma resumida de la siguiente manera:

-   **Frecuencia absoluta de x**: n췈 de veces que se repite cada modalidad de x.

-   **Frecuencia relativa de x**: proporci칩n de veces que se repite cada modalidad de x.

-   **Frecuencia absoluta acumulada de x**: n췈 de observaciones menores o iguales que cada modalidad de x (solo apto para cuantitativas o cualitativas ordinales ya que necesitamos una estructura de orden).

-   **Frecuencia relativa acumulada de x**: proporci칩n de valores menores o iguales que cada modalidad de x (solo apto para cuantitativas o cualitativas ordinales ya que necesitamos una estructura de orden).


| Valores de la variable | Frecuecias Absolutas | Frecuencias relativas | Frecuencias Absolutas acumuladas | Frecuencias Relativas acumuladas |
|:-----------------------|:---------------------|:----------------------|:---------------------------------|:---------------------------------|
| $x_i$                  | $f_i$                | $p_i$                 | $F_i$                            | $P_i$                            |

#### Ejemplo 1

En un estudio sobre el [**grupo sangu칤neo realizado con** $n = 6313$ individuos]{.hl-yellow} se obtuvo la siguiente tabla de frecuencias La variable tiene $k = 4$ modalidades (O, A, B, AB).

| Valores de la variable | Frecuecias Absolutas | Frecuencias relativas | Frecuencias Absolutas acumuladas | Frecuencias Relativas acumuladas |
|:-----------------------|:---------------------|:----------------------|:---------------------------------|:---------------------------------|
| $x_i$                  | $f_i$                | $p_i$                 | $F_i$                            | $P_i$                            |
| O                      | 2892                 | 2892/6313 = 0.458     | 2892                             | 0.458                            |
| A                      | 2625                 | 1625/6313 = 0.416     | 5517                             | 0.874                            |
| B                      | 570                  | 570/6313 = 0.09       | 6087                             | 0.964                            |
| AB                     | 226                  | 226/6313 = 0.036      | 6313                             | 1                                |
| TOTAL                  | 6313                 | 1                     | 6313                             | 1                                |

$$\sum^k_{i=1} f_i=n$$ $$\sum^k_{i=1} p_i = 1$$



쯈u칠 **conclusiones** sacar칤as al ver esta tabla?

&nbsp;

La gran mayor칤a de esta muestra tiene grupo sangu칤neo O 칩 A con un 46% y 42% respectivamente y que los grupos B y AB son minoritarios, siendo el AB la modalidad minoritaria.

#### Ejemplo 2

Otro ejemplo: las edades en un grupo de $n = 25$ estudiantes universitarios

| Valores de la variable | Frecuecias Absolutas | Frecuencias relativas | Frecuencias Absolutas acumuladas | Frecuencias Relativas acumuladas |
|:-----------------------|:---------------------|:----------------------|:---------------------------------|:---------------------------------|
| $x_i$                  | $f_i$                | $p_i$                 | $F_i$                            | $P_i$                            |
| 18                     | 6                    | 0.24                  | 6                                | 0.24                             |
| 19                     | 5                    | 0.20                  | 11                               | 0.44                             |
| 20                     | 3                    | 0.12                  | 14                               | 0.56                             |
| 21                     | 3                    | 0.12                  | 17                               | 0.68                             |
| 22                     | 3                    | 0.12                  | 20                               | 0.80                             |
| 23                     | 3                    | 0.12                  | 23                               | 0.92                             |
| 24                     | 2                    | 0.08                  | 25                               | 1                                |
| Total                  | 25                   | 1                     | 25                               | 1                                |


Contesta a las siguientes preguntas sobre la tabla anterior:

-   쮺u치ntos individuos tienen 21 a침os?

-   쯈u칠 porcentaje de individuos tiene m치s de 19 a침os?

#### Ejemplo 3

쯈u칠 pasa cuando tenemos una [**variable cuantitativa continua**]{.hl-red}?

Imagina que anotamos las puntuaciones obtenidas por 100 pacientes en un test psicol칩gico en una escala continua del 0 al 100.

$x_i$: 11,42,58,25,48,18,45,35,59,29,35,2,37,68,70,31,44,84,64,82,26,42,51,29, 59,92,56,5,52,8,1,12,21,6,32,15,67,47,61,47,43,33,48,47,43,69,49,21,9,15,11,22, 29,14,31,46,19,49,51,71,52,32,51,44,58,60,43,65,73,62,3,17,39,22,40,65,30,31,16, 80,41,59,60,41,51,10,63,41,74,81,20,36,59,38,40,43,18,60,71,44.

쯊iene sentido hacer una tabla de frecuencias? 쯅os resume la informaci칩n? 쯈u칠 podemos hacer?



| $x_i$     | $f_i$ | $p_i$ | $F_i$ | $P_i$ |
|:----------|:------|:------|:------|:------|
| \[0,10\]  | 8     | 0.08  | 8     | 0.08  |
| (10,20\]  | 12    | 0.12  | 20    | 0.20  |
| (20,30\]  | 10    | 0.1   | 30    | 0.30  |
| (30,40\]  | 14    | 0.14  | 44    | 0.44  |
| (40,50\]  | 21    | 0.21  | 65    | 0.65  |
| (50,60\]  | 16    | 0.16  | 81    | 0.81  |
| (60,70\]  | 10    | 0.10  | 91    | 0.91  |
| (70,80\]  | 5     | 0.05  | 96    | 0.96  |
| (80,90\]  | 3     | 0.03  | 99    | 0.99  |
| (90,100\] | 1     | 0.01  | 100   | 1     |
| Total     | 100   | 1     |       |       |

#### Tablas de frecuencia en R

Los **res칰menes num칠ricos** deber칤amos saber hacerlos en  `R` con `datos |> summarise()` pero... [**쯫 las tablas de frecuencia o contigencia (unidimensionales de momento)?**]{.hl-yellow}. Por ejemplo, vamos a realizar un [**conteo de frecuencias de la variable `hair_color`**]{.hl-yellow} de starwars. Para ello en tidyverse basta usar `count()`

```{r}
tabla_freq <- 
  starwars |>
  drop_na(hair_color) |> 
  count(hair_color)
tabla_freq
```


Si te fijas la [**frecuencia absoluta viene siempre como $n$**]{.hl-yellow} pero podemos **renombrarla**

```{r}
tabla_freq <-
  tabla_freq |> 
  rename(frec_abs = n)
tabla_freq
```


A esa tabla de frecuencias podemos a침adirle la [**frecuencia relativa**]{.hl-yellow} calculada como cada frecuencia absoluta dividida por el total (la suma de todos)

```{r}
tabla_freq <-
  tabla_freq |> 
  mutate("frec_rel" = frec_abs / sum(frec_abs))
tabla_freq
```


Este proceso podemos obtenerlo de forma [**m치s sencilla con `R base`**]{.hl-yellow} (recuerda: funciones aplican a vectores aislados, que debes sacar de la tabla con `$` y sin tuber칤as) con la funci칩n `table()`

```{r}
tabla_freq <-
 table(starwars$hair_color)
tabla_freq
```


Tambi칠n podemos obtener en `R base` las [**frecuencias realtivas**]{.hl-yellow} aplicando `prop.table()` a la tabla de frecuencias anterior.

```{r}
prop.table(tabla_freq)
```

[**Moraleja**]{.hl-green}: no te cases de manera ac칠rrima con una forma de hacer las cosas, ambos mundos van a ser necesarios.

#### Par칠ntesis: sample

Imagina que queremos a침adir una columna nueva llamada `rol` tal que a cada persona le asignamos de manera aleatoria `"bueno"` (con probabilidad 0.45), `"malo"` (con probabilidad 0.35), `"villano"` (con probabilidad 0.2)

Para [**generar experimentos aleatorios de una variable cualitativa**]{.hl-yellow} contamos con `sample(x = ..., size = ..., replace = ..., probs = ...)`:

* `x = c("cruz", "cara")`: las opciones que permitimos que salgan.
* `size = 20`: las veces que 춺tiramos la moneda췉.
* `replace = TRUE`: si permitimos reemplazamiento (pueden salir elementos repetidos) o no (en este caso solo podr칤amos tirar 2 veces).
* `prob = c(0.3, 0.7)`: las probabilidades de los posibles eventos


En nuestro caso de ejemplo estamos tirando una **moneda trucada (m치s caras que cruces) 20 veces**.

```{r}
sample(x = c("cruz", "cara"), size = 20, replace = TRUE, prob = c(0.3, 0.7))
```

#### Frecuencias acumuladas

Imagina que queremos a침adir una columna nueva llamada `rol` tal que a cada persona le asignamos de manera aleatoria `"bueno"` (con probabilidad 0.45), `"malo"` (con probabilidad 0.35), `"villano"` (con probabilidad 0.2)

Tendremos que hacer un `sample()` con las 3 opciones (y sus probabilidades) de tama침o 87 (tenemos 87 personajes).

```{r}
starwars <- 
  starwars |> 
  mutate("rol" = sample(x = c("bueno", "malo", "villano"), size = 87,
                        replace = TRUE, prob = c(0.45, 0.35, 0.2)),
         .after = name)
starwars
```


Si te fijas esa variable no solo es cualitativa sino ordinal. Entre las variables cualitativas tenemos [**nominales**]{.hl-yellow} (g칠nero, sexo, estado civil, etc) y [**ordinales**]{.hl-yellow} (estado de salud, rol, etc). 쮺칩mo distinguirlas? La forma que tenemos en `R` de indicarle que una variable de tipo texto (universo inform치tico) es una cualitativa y de qu칠 tipo (universo estad칤stica) es haciendo uso de lo que se conoce como [**factores**]{.hl-yellow}

#### Par칠ntesis: factores

En `R` las [**variables cualitativas pueden ser tratadas como tales**]{.hl-yellow} convirtiendo una cadena de texto a lo que se conoce como [**factor**]{.hl-yellow}. Por ejemplo, supongamos que tenemos un vector de notas

```{r}
notas <- c("suspenso", "notable", "suspenso", "aprobado", "notable", "suspenso")
notas
```

Para [**convertir a factor nos basta con `factor()`**]{.hl-yellow}. 쯈u칠 notas diferente?

```{r}
notas_fct <- factor(notas)
notas_fct
```


Si te fijas ahora [**tenemos disponibles unos niveles (levels)**]{.hl-yellow}: son las posibles modalidades de nuestra variable cualitativa, el soporte, de manera que aunque borremos uno de ellos (vamos a borrar todos los aprobados), la opci칩n sigue disponible si entrase un dato nuevo (algo as칤 como un men칰 de opciones permitidas)

```{r}
notas_fct[notas_fct != "aprobado"]
```


En el caso de las [**cualitativas ordinales podemos incluso establecer una jerarqu칤a**]{.hl-yellow}, indicando expl칤citamente los niveles y `ordered = TRUE`

```{r}
notas_fct_ord <- factor(notas, levels = c("aprobado", "notable", "suspenso"),
                        ordered = TRUE)
notas_fct_ord
```

F칤jate que ahora tenemos una [**jerarqu칤a**]{.hl-yellow} y aunque sea cualitativa podemos buscar [**elementos \<= o \>= que otros**]{.hl-yellow}

```{r}
notas_fct_ord[notas_fct_ord <= "notable"]
```

#### Frecuencias acumuladas

Volvamos a nuestro ejemplo: 쯖칩mo convertir nuestra nueva variable rol en una variable cualitativa ordinal (en orden de maldad)? Debemos usar el concepto de factor pero para no aislar la variable de su tabla, lo introduciremos en un `mutate()`

```{r}
starwars <-
  starwars |> 
  mutate("rol" = factor(rol, levels = c("bueno", "malo", "villano"),
                        ordered = TRUE))
```


Cuando tenemos una variable ordinal no solo vamos a poder calcular la tabla de frecuencias absoluta y relativa...

```{r}
tabla_freq <-
  starwars |> 
  count(rol) |> 
  mutate("frec_rel" = n/sum(n))
tabla_freq

# o bien
table(starwars$rol)
```


...sino que al tener una [**jerarqu칤a de orden**]{.hl-yellow} (f칤jate que salen autom치ticamente ordenados) vamos a poder calcular las [**frecuencias acumuladas**]{.hl-yellow} con `cumsum()`

```{r}
tabla_freq <-
  tabla_freq |>
  mutate("frec_abs_acum" = cumsum(n),
         "frec_rel_acum" = cumsum(frec_rel))
tabla_freq

# o bien
cumsum(table(starwars$rol))
cumsum(prop.table(table(starwars$rol)))
```

### 游눹 Tu turno

[**Intenta realizar los siguientes ejercicios sin mirar las soluciones**]{style="color:#444442;"}

::: panel-tabset
### [**Ejercicio 1**]{.hl-yellow}

游닇 Para repasar lo aprendido vamos a poner todo en pr치ctica con el dataset `SatisfaccionPacientes.csv` que ten칠is subido al campus. [**쮺칩mo importarlo?**]{.hl-yellow}.

```{r}
#| code-fold: true
library(readr) # dentro de tidyverse
# en mi caso tengo el .csv en una carpeta datos dentro del proyecto
datos <-
  read_csv(file = "./datos/SatisfaccionPacientes.csv") |> 
  # la funci칩n clean_names del paquete janitor 
  # nos normaliza nombres de variables
  janitor::clean_names()
```

### [**Ejercicio 2**]{.hl-yellow}

游닇 Aplica el c칩digo que sea necesario para responder a estas preguntas. 쮺u치l es el tama침o muestral? 쮺u치ntas variables tenemos? 쮺u치ntas modalidades tenemos en la variable `estado_civil` (y cuantas observaciones en cada una)?

```{r}
#| code-fold: true
#| eval: false

# Tama침o muestral / n칰mero de observaciones
n <- nrow(datos)

# N칰mero de variables
p <- ncol(datos)

# 쯈u칠 modalidades tenemos?
datos |> 
  count(estado_civil)
```


### [**Ejercicio 3**]{.hl-yellow}

游닇 Determina el tipo de variable (cuantitativa vs. cualitativa).

```{r}
#| code-fold: true
#| eval: false
# Variables cuantitativas: tiempo, grado satisfacci칩n, n칰mero de visitas
# Variables cualitativas: g칠nero, estado civil, estado salud
glimpse(datos)
```

### [**Ejercicio 4**]{.hl-yellow}

游닇  Obten tablas de frecuencias (absoluta y relativa) en el caso de las cualitativas NOMINALES. Con ella intenta responder a las preguntas: a) 쯖u치ntas mujeres hay? b) 쯤u칠 % de individuos est치n casados?

```{r}
#| code-fold: true
#| eval: false

# no podemos calcular acumulados ya que  genero es nominal
freq_genero <-
  datos |> 
  count(genero) |> 
  rename(frecuencia_abs = n) |> 
  mutate(frecuencia_rel = frecuencia_abs/sum(frecuencia_abs))
# Hay 53 mujeres

freq_estado_civil <-
  datos |> 
  count(estado_civil) |> 
  rename(frecuencia_abs = n) |> 
  mutate(frecuencia_rel = frecuencia_abs/sum(frecuencia_abs))
# Hay 26% personas casadas
```


### [**Ejercicio 5**]{.hl-yellow}

游닇 Convierte de manera adecuada la variable `genero` y `estado_civil` a cualitativa nominal

```{r}
#| code-fold: true
datos <-
  datos |>
  mutate(estado_civil = factor(estado_civil),
         genero = factor(genero))
```

### [**Ejercicio 6**]{.hl-yellow}

游닇 Calcula la media, mediana, rango intercuart칤lico y desviaci칩n t칤pica de edad y tiempo de espera.

```{r}
#| code-fold: true
resumen <-
  datos |>
  summarise(media_edad = mean(edad), sd_edad = sd(edad), mediana_edad = median(edad),
           IQR_edad = quantile(edad, probs = 0.75) - quantile(edad, probs = 0.25),
           # tiempo espera
           media_tiempo_espera = mean(tiempo_espera), sd_tiempo_espera = sd(tiempo_espera),
           mediana_tiempo_espera = median(tiempo_espera),
           IQR_tiempo_espera = quantile(tiempo_espera, probs = 0.75) - quantile(tiempo_espera, probs = 0.25))
```

### [**Ejercicio 7**]{.hl-yellow}

游닇 Repite el anterior ejercicio pero obteniendo las m칠tricas desagregadas por sexo.

```{r}
#| code-fold: true
resumen <-
  datos |>
  summarise(media_edad = mean(edad), sd_edad = sd(edad), mediana_edad = median(edad),
           IQR_edad = quantile(edad, probs = 0.75) - quantile(edad, probs = 0.25),
           # tiempo espera
           media_tiempo_espera = mean(tiempo_espera), sd_tiempo_espera = sd(tiempo_espera),
           mediana_tiempo_espera = median(tiempo_espera),
           IQR_tiempo_espera = quantile(tiempo_espera, probs = 0.75) - quantile(tiempo_espera, probs = 0.25),
          .by = genero)
```

### [**Ejercicio 8**]{.hl-yellow}

游닇 Realiza un gr치fico de viol칤n para la variable `tiempo_espera` para cada g칠nero

```{r}
#| code-fold: true
ggplot(datos) +
  geom_violin(aes(x = genero, y = tiempo_espera, fill = genero, color = genero),
              alpha = 0.7) +
  ggthemes::scale_color_colorblind() +
  ggthemes::scale_fill_colorblind() +
  theme_minimal()
```

:::

## 游냒 Caso pr치ctico: encuesta de satisfacci칩n

Vamos a seguir poniendo en pr치ctica lo aprendido el dataset `SatisfaccionPacientes.csv` que ten칠is subido al campus, tras haberle normalizado nombres y convertido las variables que tocaban a cualitativas nominales.


```{r}
library(readr) # dentro de tidyverse
# en mi caso tengo el .csv en una carpeta datos dentro del proyecto
datos <-
  read_csv(file = "./datos/SatisfaccionPacientes.csv") |> 
  # la funci칩n clean_names del paquete janitor 
  # nos normaliza nombres de variables
  janitor::clean_names() |>
  mutate(estado_civil = factor(estado_civil),
         genero = factor(genero))
datos
```

### Pregunta 1

> Convierte de manera adecuada la variable `estado_salud` a cualitativa ORDINAL

```{r}
#| code-fold: true
datos <-
  datos |>
  mutate(estado_salud =
           factor(estado_salud, levels = c("Malo", "Regular", "Bueno", "Excelente"),
                  ordered = TRUE))
```

### Pregunta 2

> Haz uso de `table()` para calcular la tabla de frecuencias de `genero` y `estado_civil`

```{r}
#| code-fold: true
#| eval: false
table(datos$genero)
table(datos$estado_civil)
```

### Pregunta 3

>  Calcula la tabla de frecuencias de las ORDINALES y piensa si ahora puedes a침adir algo m치s a la tabla de frecuencias). Tras ello usa el c칩digo m치s sencillo para responder a: 쯖u치ntas personas tienen un estado de salud regular (o peor)?

```{r}
#| code-fold: true
#| eval: false
freq_estado_salud <-
  datos |> 
  count(estado_salud) |> 
  rename(frecuencia_abs = n) |> 
  mutate(frecuencia_rel = frecuencia_abs/sum(frecuencia_abs),
         frecuencia_acum_abs = cumsum(frecuencia_abs),
         frecuencia_acum_rel = cumsum(frecuencia_rel))
# Se ve dentro de la tabla. Hay 44+15 = 59 personas con un estado de salud malo o regular. 
# Con c칩digo
datos |>
  count(estado_salud <= "Regular")
```

### Pregunta 4

>  Si te fijas una de las modalidades es totalmente anecd칩tica (solo 1 Excelente). Ser칤a conveniente recategorizar la categor칤a Excelente: siempre que detecte Excelente, lo debe recategorizar a Bueno (criterio general: las categor칤as deben contener al menos un 5% de los individuos de toda la muestra). Pista: mutate e if_else

```{r}
#| code-fold: true
datos <- 
  datos |> 
  mutate(estado_salud  = if_else(estado_salud  == "Excelente", "Bueno", estado_salud),
         # ojo: hay que redefinir los niveles de la cualitativa
         # ya que ha dejado de ser factor (veremos un d칤a el paquete forcats para esto)
         estado_salud =
           factor(estado_salud, levels = c("Malo", "Regular", "Bueno"),
                  ordered = TRUE))
```

### Pregunta 5

>  Calcula la media, mediana, rango intercuart칤lico y desviaci칩n t칤pica de grado de satisfacci칩n desagregado por sexo.

```{r}
#| code-fold: true
resumen <-
  datos |>
  summarise(media_grado_satisfaccion = mean(grado_satisfaccion),
           sd_grado_satisfaccion = sd(grado_satisfaccion),
           mediana_grado_satisfaccion = median(grado_satisfaccion),
           IQR_grado_satisfaccion =
             quantile(grado_satisfaccion, probs = 0.75) -
             quantile(grado_satisfaccion, probs = 0.25),
           .by = genero)
```

### Pregunta 6

> Exporta los resultados anteriores (`resumen`) en un archivo `resumen.csv`. En lugar de un `read_csv()` vamos a usar `write_csv(tabla, file = "ruta")`

```{r}
#| code-fold: true
# importado como csv
write_csv(resumen, file = "./resumen.csv")
```

### Pregunta 7

> Crear un diagrama de barras para la variable g칠nero.

```{r}
#| code-fold: true
# G칠nero: f칤jate que por defecto `geom_bar()` cuenta y visualiza ese conteo `n`.
ggplot(datos) +
  geom_bar(aes(x = genero)) 
```


### Pregunta 8

> 쮺칩mo podr칤amos decirle que cada barra (es decir, para cada modalidad de g칠nero) sea de un color (de relleno)?

```{r}
#| code-fold: true
ggplot(datos) +
  # dentro de aes() para que dependa de la tabla
  geom_bar(aes(x = genero, fill = genero))
```

### Pregunta 9

>  En un gr치fico no solo podemos usar color como par치metro est칠tico el color sino jugar por ejemplo con la transparencia (par치metro `alpha`). Modifica el gr치fico anterior para hacer los colores un poco m치s transparentes.

```{r}
#| code-fold: true
ggplot(datos) +
  geom_bar(aes(x = genero, fill = genero), alpha = 0.75) 
```

### Pregunta 10

> Una capa muy importante en ggplot es `labs()`. A침ade t칤tulos a los ejes, leyendas, t칤tulo de gr치fica, subt칤tulo y pie de figura.

```{r}
#| code-fold: true
ggplot(datos) +
  geom_bar(aes(x = genero, fill = genero), alpha = 0.75) +
  labs(title = "Diagrama de barras de la variable g칠nero", 
       subtitle = "Encuesta satisfacci칩n",
       caption = "Autor: J. 츼lvarez y A. Moreno",
       x = "Categor칤a", y = "Frecuencia absoluta", fill = "Categor칤a")
```

### Pregunta 11

> Tambi칠n podemos a침adir una capa de tema: unos ajustes (fuente de letra, tama침o, colores de fondo, etc) ya predefinidos. El m치s "austero" pero cuco es `theme_minimal()`

```{r}
ggplot(datos) +
  geom_bar(aes(x = genero, fill = genero), alpha = 0.75) +
  labs(title = "Diagrama de barras de la variable g칠nero", 
       x = "Categor칤a", y = "Frecuencia absoluta",
       fill = "Categor칤a") +
  theme_minimal() 
```

Tienes m치s temas en el paquete `{ggthemes}`

```{r}
ggplot(datos) +
  geom_bar(aes(x = genero, fill = genero), alpha = 0.75) +
  labs(title = "Diagrama de barras de la variable g칠nero", 
       x = "Categor칤a", y = "Frecuencia absoluta",
       fill = "Categor칤a") +
  ggthemes::theme_economist()
```


> Haz el gr치fico anterior pero decidiendo t칰 qu칠 colores asignas a cada g칠nero y con un tema 

```{r}
#| code-fold: true
ggplot(datos) +
  geom_bar(aes(x = genero, fill = genero), alpha = 0.75) +
  # reminder: el relleno es fill, color para el reborde si quieres
  scale_fill_manual(values = c("#379e98", "#eaea3e")) +
  labs(title = "Diagrama de barras de la variable g칠nero", 
       x = "Categor칤a", y = "Frecuencia absoluta",
       fill = "Categor칤a") +
 theme_minimal()
```


En el paquete `{ggthemes}` tienes ya algunas paletas a usar si quieres, por ejemplo para personas dalt칩nicas `scale_fill_colorblind()`

```{r}
ggplot(datos) +
  geom_bar(aes(x = genero, fill = genero), alpha = 0.75) +
  ggthemes::scale_fill_colorblind() +
  labs(title = "Diagrama de barras de la variable g칠nero", 
       x = "Categor칤a", y = "Frecuencia absoluta",
       fill = "Categor칤a") +
 theme_minimal()
```

### Pregunta 12

> Crear desde cero un diagrama de barras, con ajustes personalizados vistos en los ejercicios anterioes, para la variable estado de salud

```{r}
#| code-fold: true
# Estado de salud (ahora el orden importa)
ggplot(datos) +
  geom_bar(aes(x = estado_salud, fill = estado_salud), alpha = 0.75) +
  ggthemes::scale_fill_colorblind() +
  labs(title = "Diagrama de barras de la variable estado salud", 
       x = "Categor칤a",  y = "Frecuencia absoluta",
       fill = "Categor칤a") +
  theme_minimal() 
```


F칤jate que si **no tuvi칠semos la variable como cuali ordinal, las barras van por orden alfab칠tico**, no por jerarqu칤a real

```{r}
ggplot(datos) +
  geom_bar(aes(x = as.character(estado_salud), fill = as.character(estado_salud)),
           alpha = 0.75) +
  ggthemes::scale_fill_colorblind() +
  labs(title = "Diagrama de barras de la variable estado salud", 
       x = "Categor칤a",  y = "Frecuencia absoluta",
       fill = "Categor칤a") +
  theme_minimal() 
```

### Pregunta 13

> Crea el histograma inferior para las variable edad y tiempo de espera.

```{r}
#| code-fold: true
ggplot(datos) +
  geom_histogram(aes(x = edad), bins = 30, fill = "darkorange", alpha = 0.75) + 
  labs(title = "Histograma de edad", subtitle = "Bins = 30",
       x = "Valores", y = "Frecuencia absoluta") +
  theme_minimal()

ggplot(datos) +
  # Define el ancho de las barras y colores
  geom_histogram(aes(x = tiempo_espera), bins = 30, fill = "orchid", alpha = 0.75) + 
  labs(title = "Histograma de tiempo de espera", subtitle = "Bins = 30",
       x = "Valores", y = "Frecuencia absoluta") +
  theme_minimal()
```

### Pregunta 14

> Crea el gr치fico de densidad inferior para las variable edad y tiempo de espera.

```{r}
#| code-fold: true
ggplot(datos) +
  geom_density(aes(x = edad), color = "darkorange", 
               fill = "darkorange", alpha = 0.75) + 
  labs(title = "Gr치fico de densidad de edad",
       x = "Valores", y = "Frecuencia relativa") +
  theme_minimal()

ggplot(datos) +
  geom_density(aes(x = tiempo_espera), color = "orchid", 
               fill = "orchid", alpha = 0.75) + 
  labs(title = "Gr치fico de densidad de tiempo de espera",
       x = "Valores", y = "Frecuencia relativa") +
  theme_minimal()
```

### Pregunta 15

> Crea el histograma inferior para la variable grado_satisfaccion. 쯈u칠 opinas?

```{r}
#| code-fold: true
# Representaci칩n regular, no aporta ni resume
ggplot(datos) +
  # Define el ancho de las barras y colores
  geom_histogram(aes(x = grado_satisfaccion), bins = 30, fill = "#308b8e", alpha = 0.75) + 
  labs(title = "Histograma de grado de satisfacci칩n", subtitle = "Bins = 30",
       x = "Valores", y = "Frecuencia absoluta") +
  theme_minimal()
# Las **variables discretas muchas veces son mejor representadas** con una diagrama de barras
```


### Pregunta 16

> Realiza un boxplot para edad y un boxplot para numero de visitas PERO por g칠nero (dos variables, piensa c칩mo)

```{r}
#| code-fold: true
ggplot(datos) +
  geom_boxplot(aes(y = edad), fill = "lightblue", alpha = 0.75) +  
  labs(title = "Boxplot de edad",  y = "Edad") +
  theme_minimal()

ggplot(datos) +
  geom_boxplot(aes(x = genero, y = tiempo_espera, fill = genero),
               alpha = 0.75) +
  labs(title = "Boxplot de tiempo de espera por g칠nero", 
       x = "G칠nero", y = "Tiempo de Espera") +
  theme_minimal()
```


> Haciendo uso del gr치fico anterior:

a)  쯃a variable edad tiene outliers? 쯈u칠 edad tienen esos pacientes?

b)  쯈ui칠n ha esperado m치s los hombres o las mujeres?


En los boxplots podemos tambi칠n **indicar par치metros concretos para los outliers**.

```{r}
ggplot(datos) +
  geom_boxplot(aes(y = edad), fill = "lightblue", alpha = 0.75,
               outlier.colour = "red", outlier.shape = 18, outlier.size = 3) +  
  labs(title = "Boxplot de edad",  y = "Edad") +
  theme_minimal()
```




## Estad칤stica descriptiva bivariante

Todo lo que hemos hecho con una variable podemos hacerlo tambi칠n de manera [**bivariante**]{.hl-yellow} considerando dos variables. 
Uno de los principales objetivos de la estad칤stica bivariante es [**determinar si existe relaci칩n o dependencia entre dos variables**]{.hl-yellow}, es decir, cuando un cambio en el valor de una de ellas se asocia a un cambio en el de la otra (una [**dependencia estad칤stica no implica un efecto causal**]{.hl-red}). La situaci칩n contraria, es decir, la ausencia de relaci칩n, se denomina [**independencia**]{.hl-yellow}.

Una primera aproximaci칩n al estudio de dos variables ser치 [**clasificar el tipo de an치lisis**]{.hl-yellow}

- [**Cuali vs cuali**]{.hl-yellow}:
  - **Resumen**: tablas de contigencia (frecuencia cruzada).
  - **Inferencia**: prueba $\chi^2$ de independencia o test de Fisher.
  - **Gr치ficos**: barras apiladas, gofres, gr치ficos de 춺flujo췉.

- [**Cuanti vs cuanti**]{.hl-yellow}:
  - **Resumen**: covarianza y correlaci칩n.
  - **Inferencia**: test de correlaci칩n (relaci칩n lineal) y test de Kolmogorov-Smirnov (쯔mbas distribuciones son iguales?). Test de igualdad de medias o igualdad de varianzas
  - **Gr치ficos**: diagrama de dispersi칩n, correlogramas, heatmaps.

- [**Cuanti vs cuali**]{.hl-yellow}:
  - **Resumen**: medidas de centralizaci칩n/dispersi칩n/posici칩n de la cuanti desagregado por los grupos de la cuali.
  - **Inferencia**: ANOVA (una v칤a, dos v칤as, ...). Test de igualdad de medias o igualdad de varianzas (desagregada por grupos)
  - **Gr치ficos**: boxplots, gr치ficos de viol칤n (desagregados por grupos)


### Introducci칩n a inferencia

쯇ero que es eso de la [**inferencia estad칤stica**]{.hl-yellow}? Es un conjunto de m칠todos y t칠cnicas que permite [**inferir conclusiones sobre una poblaci칩n a partir de una muestra**]{.hl-yellow} de datos.



Su prop칩sito es utilizar la informaci칩n muestral para estimar caracter칤sticas de la poblaci칩n, probar hip칩tesis y realizar predicciones, basado en el c치lculo de [**estad칤sticos**]{.hl-yellow}

-   [**Par치metro**]{.hl-yellow}: medida que describe una caracter칤stica de la **poblaci칩n** (ejemplo: la media poblacional $\mu$ de la estatura de las mujeres en Espa침a).

-   [**Estad칤stico**]{.hl-yellow}: medida que describe una caracter칤stica de la **muestra** (ejemplo: la media muestral $\overline{x}$ de un conjunto de 100 mujeres).


Haciendo uso de **estad칤sticos que aproximen una correcta estimaci칩n de los par치metros**, los [**contraste de hip칩tesis**]{.hl-yellow} son procedimientos estad칤sticos para [**tomar decisiones sobre la validez de una afirmaci칩n acerca de una poblaci칩n**]{.hl-yellow} en funci칩n de los datos muestrales.


La idea es muy parecido a un **juicio**: con las pruebas (muestra) el jurado (estad칤stico) deben decidir sobre tu culpabilidad real (poblaci칩n), pudiendo ser declarado **culpable** o **no culpable**. Este proceso implica formular

-   [**Hip칩tesis nula** $H_0$]{.hl-yellow}: es una afirmaci칩n generalmente representa una **posici칩n de no efecto o no diferencia** (ejemplo: entras siendo no culpable a un juicio)

-   [**Hip칩tesis alternativa** $H_0$]{.hl-yellow}: es una afirmaci칩n que [**se acepta si se rechaza la hip칩tesis nula**]{.hl-yellow}. Representa un efecto o diferencia (ejemplo: culpable)

La idea es similar a la del juicio: solo vamos a [**rechazar** $H_0$ (es decir, aceptar $H_1$) si hay MUCHAS EVIDENCIAS en la muestra]{.hl-yellow} (solo se condena culpable a una persona si hay muchas evidencias que demuestran su culpabilidad, pero el acusado no tiene que demostrar su inocencia).

&nbsp;

Llamaremos [**nivel de significancia** $\alpha$]{.hl-yellow} a la probabilidad de [**rechazar la hip칩tesis nula cuando es verdadera**]{.hl-red} (condenar a un inocente, conocido como **error tipo I**. Normalmente $\alpha = 0.05$ aunque se pueden usar otros valores como 0.01 o 0.10 (a decidir ANTES de realizar el contraste.)

#### Ejemplo

Supongamos que estamos probando si un nuevo medicamento tiene un efecto en la presi칩n arterial $\mu$

$$H_0:~\mu = \mu_0~\text{(medicamento no tiene efecto sobre la presi칩n arterial)}$$ $$H_1:~\mu \neq \mu_0~\text{(medicamento SI tiene efecto sobre la presi칩n arterial)}$$

donde $\mu_0$ es la media de la presi칩n arterial antes del tratamiento.


| Decisi칩n  | $H_0$ es cierta | $H_1$ es cierta |
|:---------:|:---------------:|:---------------:|
| Se decide rechazar $H_0$ | Error de tipo I   |  Acierto   |
| Se decide no rechazar $H_0$ | Acierto   |  Error de tipo II  |

#### p-valor


El conocido como [**p-valor**]{.hl-yellow} es uno de los conceptos m치s importantes en estad칤stica pero tambi칠n peor usados. Puedes ver toda una revisi칩n de qu칠 significa y qu칠 no en <https://pmc.ncbi.nlm.nih.gov/articles/PMC4877414/>

Podemos definir el [**p-valor**]{.hl-yellow} como un valor continuo que nos mide la [**compatibilidad de los datos observados con el modelo e hip칩tesis asumidas**]{.hl-yellow}: 1 indica compatibilidad perfecta y 0 incompatibilidad completa.

* [**No repesenta la probabilidad de que la hip칩tesis nula sea cierta**]{.hl-red}: el propio p-valor se calcula ASUMIENDO que lo es.

* [**No repesenta la probabilidad de que, por azar, se produzca nada**]{.hl-red}


### An치lisis de variables cuali vs cuali

Una vez visto conceptos b치sicos de inferencia vamos a empezar por un [**an치lisis bivariante de dos variables cualitativas**]{.hl-yellow}.

#### Tablas de contigencia

El primer paso siempre ser치 intentar resumir la informaci칩n mediante el uso de [**tablas de contigencia**]{.hl-yellow}, en este caso bidimensionales.

&nbsp;

쮺칩mo lo har칤as con **tidyverse**? 쯏 con **R base**?


Vamos a tomar de nuevo nuestros datos de satisfacci칩n de pacientes

```{r}
library(readr)
datos <-
  read_csv(file = "./datos/SatisfaccionPacientes.csv") |> 
  janitor::clean_names()
```

Para calcular una tabla bidimensional de frecuencias en tidyverse basta con **indicar dos variables en `count()`**

```{r}
datos |>
  count(genero, estado_civil)
```


Lo habitual es mostrar esta tabla como una [**tabla con m filas y n columnas**]{.hl-yellow}, siendo $m$ el n칰mero de modalidades distintas de la primera variable (en este caso $m=2$, femenino y masculino) y $n$ el n칰mero de modalidades distintas de la segunda variable (en este caso $n = 4$). 

쮺칩mo hacer que la variable `estado_civil` pivote para pasar de estar en vertical a estar 춺en horizontal췉? (echa un repaso a la parte de tidy data)


```{r}
datos |>
  count(genero, estado_civil) |> 
  pivot_wider(names_from = estado_civil, values_from = n)
```



Esto se puede hacer **mucho m치s sencillo de nuevo en `R base`** con `table()`


```{r}
table(datos$genero, datos$estado_civil)
```



F칤jate que ahora podemos [**normalizar las frecuencias de 3 formas**]{.hl-yellow}: respecto al total de los datos, por filas (`margin = 1`) o por columnas (`margin = 2`).

```{r}
prop.table(table(datos$genero, datos$estado_civil))
prop.table(table(datos$genero, datos$estado_civil), margin = 1)
prop.table(table(datos$genero, datos$estado_civil), margin = 2)

```


Haciendo uso de las tablas anteriores intenta responder a las siguientes preguntas:

a) 쯈u칠 cantidad de pacientes mujeres est치n solteras?

b) 쯈u칠 porcentaje, de entre los pacientes hombres, est치n viudos?

c) 쯈u칠 porcentaje, de entre los que est치n divorciados, son mujeres?

d) 쯈u칠 porcentaje (del total de pacientes) son hombres solteros?


```{r}
#| code-fold: true
# a) 22 mujeres
# b) 8.51%
# c) 57.89%
# d) 20%
```


##### Visualizaci칩n de tablas: geom_tile()
Puedes incluso visualizar dichas cantidades con `geom_tile()` indic치ndole que el relleno dependa del conteo `n`

```{r}
datos |>
  count(genero, estado_civil) |>
  ggplot() +
  geom_tile(aes(x = genero, y = estado_civil, fill = n)) +
  theme_minimal()
```

#### Inferencia cuali vs cuali: prueba chi-cuadrado

Esas tablas de frecuencia ser치n las que usen los [**diferentes contrastes**]{.hl-yellow} para decidir si hay o no dependencia entre ellas.

&nbsp;

El contraste m치s conocido es la conocida como [**prueba de $\chi^2$ (chi-cuadrado)**]{.hl-yellow}: dada una tabla de contigencia entre dos cualitativas, el contraste [**compara dicha tabla con la que deber칤amos obtener bajo la hip칩tesis nula de independencia**]{.hl-yellow}

Vamos a hacerlo con nuestras variables `genero` y `estado_civil`

$$H_0:~\text{genero y estado civil son independientes}$$

$$H_1:~\text{genero y estado civil son dependientes}$$

```{r}
table(datos$genero, datos$estado_civil)
```



[**Si la hip칩tesis nula fuese cierta**]{.hl-yellow}, 쯤u칠 esperar칤amos?


1. Elegimos uno de los factores y calculamos su **proporci칩n en la tabla general** (53% vs 47% en este caso)

```{r}
prop.table(table(datos$genero))
```


2. Calculamos la **tabla de contigencia**  de ambas variables obteniendo lo que denotaremos como [**frecuencias observadas $O_{ij}$**]{.hl-yellow}

```{r}
table(datos$genero, datos$estado_civil)
```



3. **Si ambas variables fuesen independientes**, en cada columna tendr칤amos que tener **porcentajes parecidos a cuando lo hacemos sin desagregar** (53% mujeres y 47% hombres). Es decir, del total de casados (26) deber칤amos tener $8.48$ mujeres y $7.52$ hombres; del total de divorciados (19) deber칤amos tener $10.07$ mujeres y $8.93$ hombres; y as칤 sucesivamente. Estas frecuencias las denotaremos como [**frecuencias esperadas $E_{ij}$**]{.hl-yellow}

$$E_{ij} = \frac{\text{suma fila i * suma fila j}}{\text{total}}$$




4. [**Resumimos lo que se desv칤a una de otra**]{.hl-yellow} mediante el [**estad칤stico chi-cuadrado**]{.hl-yellow}:

$$\begin{eqnarray}\chi^2 &=& \sum_{i,j} \frac{\left(O_{ij} - E_{ij} \right)^2}{E_{ij}} = \frac{(13.78 - 11)^2}{13.78} + \frac{(12.22 - 15)^2}{12.22} \nonumber \\
&+& \frac{(10.07 - 11)^2}{10.07} + \ldots + \frac{(6.11 - 4)^2}{6.11} = 2.75731\end{eqnarray}$$



5. Calculamos [**c칩mo de extremo es el valor del estad칤stico si la hip칩tesis nula fuese cierta**]{.hl-yellow}, proporcion치ndonos un **p-valor**.


Este proceso podemos hacerlo directamente aplicando `chisq.test()`, indic치ndole las variables (o su tabla de frecuencias)

```{r}
contraste <- chisq.test(datos$genero, datos$estado_civil)
```

* `...$statistic`: tenemos guardado el valor del estad칤stico

```{r}
contraste$statistic
```

* `...$observed`: tenemos guardada la tabla de frecuencias observada

```{r}
contraste$observed
```



* `...$expected`: tenemos guardada la tabla de frecuencias esperada

```{r}
contraste$expected
```

* `...$p.value`: tenemos guardado el p-valor.

```{r}
contraste$p.value
```



쮺칩mo [**interpretar el contraste**]{.hl-yellow}?

```{r}
contraste
```

Como $p.value = 0.4306 > \alpha = 0.05$, no podemos rechazar la hip칩tesis nula: [**no hay evidencias suficientes en la muestra para concluir que haya dependencia**]{.hl-yellow}.

#### Inferencia cuali vs cuali: prueba de Fisher

Otra alternativa es el [**test exacto de Fisher**]{.hl-yellow}, una prueba estad칤stica utilizada para [**determinar si hay una asociaci칩n significativa entre dos variables cualitativas**]{.hl-yellow} especialmente 칰til cuando las frecuencias esperadas son bajas y tenemos dos grupos en cada cualitativa (la tabla de frecuencias es $2 \times 2$). No entraremos en mucho detalle matem치tico pero usa la distribuci칩n real de una variable aleatoria que sigue lo que se conoce como distribuci칩n hipergeom칠trica.

&nbsp;

Como **curiosidad** dicha prueba naci칩 cuando Fisher trataba de comprobar si una compa침era, Muriel Birstol, era capaz de detectar en un t칠 con leche si se hab칤a a침adido primero el t칠 o la leche en su taza (y del experiemnto del que naci칩 la regla del $\alpha = 5%$).


Para aplicarlo nos basta con usar `fisher.test()`.

```{r}
fisher.test(datos$genero, datos$estado_civil)
```

#### M칠tricas de asociaci칩n

Como hemos dicho es especialmente 칰til cuando tenemos solo 2 modalidades en cada cualitativa ya nos proporciona [**m칠tricas de asociaci칩n**]{.hl-yellow}

Veamos un ejemplo con la tabla `placebo_medicamento.csv`

```{r}
datos_placebo <- read_csv(file = "./datos/placebo_medicamento.csv")
datos_placebo
```




```{r}
fisher.test(datos_placebo$observado, datos_placebo$grupo_tratamiento)
```

Si te fijas ahora nos devuelve adem치s un [**contraste de lo que se conoce como odds ratio (OR: raz칩n de probabilidades)**]{.hl-yellow}

`alternative hypothesis: true odds ratio is not equal to 1`


```{r}
table(datos_placebo$observado, datos_placebo$grupo_tratamiento)
```

La interpretaci칩n de [**Odds ratio (OR)**]{.hl-yellow} es cuantificar la [**asociaci칩n entre dos variables respecto a una asociaci칩n esp칰rea**]{.hl-yellow} 쮺u치nto [**mejoran los que tomaron medicamento respecto a una posible mejora basal**]{.hl-yellow} (aleatoria) del placebo?

* [**Ratio de mejora en tratados**]{.hl-purple}: $13/3 = 4.33333$
* [**Ratio de mejora en placebo**]{.hl-purple}: $6/11 = 0.54545$

$$OR = \frac{13/3}{6/11} = \frac{13*11}{6*3} = 7.94$$

Los pacientes sometidos a tratamiento mejoran 7.9 veces m치s si el placebo mejorase por azar.

&nbsp;

Otra de las m칠tricas habituales es la conocida como [**raz칩n de prevalencias (Risk Ratio, RR)**]{.hl-yellow} que nos proporciona un [**ratio entre la probabilidad de prevalencia**]{.hl-yellow} de un evento en dos grupos.


* [**Prevalencia de mejora en tratados**]{.hl-purple}: $13/(3+13) = 0.8125$
* [**Prevalencia de mejora en placebo**]{.hl-purple}: $6/(11+6) = 0.35294$

$$RR = \frac{13/(3+13)}{6/(11+6)} = \frac{13*11}{6*3} = 2.30208$$
Los pacientes sometidos a tratamiento tienen m치s del doble de 춺riesgo췉 de mejorar que los pacientes con placebo.

&nbsp;

Ambas m칠tricas podemos estimarlas tambi칠n con el paquete `{epitools}`

```{r}
library(epitools)
OR <- oddsratio(datos_placebo$observado, datos_placebo$grupo_tratamiento)
OR$measure
```

* Si $OR = 1$ no hay asociaci칩n entre las variables.
* Si $OR > 1$ hay una asociaci칩n positiva, es decir, la exposici칩n est치 asociada con un mayor riesgo.
* Si $OR < 1$ hay una asociaci칩n negativa, es decir, la exposici칩n est치 asociada con un menor riesgo.




```{r}
RR <- riskratio(datos_placebo$observado, datos_placebo$grupo_tratamiento)
RR$measure
```


* Si $RR = 1$ no hay diferencias en el riesgo entre los grupos.
* Si $RR > 1$ el grupo expuesto (en este caso medicado) tiene mayor riesgo (en este caso de mejorar)
* Si $RR < 1$ el grupo expuesto tiene menor riesgo.


#### Gr치ficos

Volvamos al ejemplo de encuesta de satisfacci칩n: vamos a intentar relacionar las dos variables cualitativas `genero` y `estado_civil` para **complementar el an치lisis num칠rico realizado** (am칠n del `geom_tile()` que hemos hecho para visualizar la tabla de frecuencias)


Sabemos realizar un diagrama de barras de cada una por separado, [**쯖칩mo incluir la informaci칩n de ambas con `geom_bar()`**]{.hl-yellow} Piensa c칩mo hacerlo recordando que `geom_bar()` solo admite una coordenada `x = ...` o `y = ...`. 쮺칩mo incluir la info de otra variable que no sea en `x` o `y`?


```{r}
#| code-fold: true
ggplot(datos) +
  geom_bar(aes(x = estado_civil, fill = genero), alpha = 0.6) +
  ggthemes::scale_fill_colorblind() +
  labs(x = "Estado civil", y = "Frec. absolutas",
       fill = "G칠nero") +
  theme_minimal()
```

&nbsp;

La funci칩n `geom_bar()` nos permite jugar un poco con el tipo de barras, que por defecto las muestra `stacked` (apiladas). Dicho ajuste podemos **cambiarlo con el argumento `position`**: si `position = "dodge"` las muestra de [**manera agrupada una detr치s de otra**]{.hl-yellow}.

```{r}
#| code-fold: true
ggplot(datos) +
  geom_bar(aes(x = estado_civil, fill = genero),
           position = "dodge", alpha = 0.6) +
  ggthemes::scale_fill_colorblind() +
  labs(x = "Estado civil", y = "Frec. absolutas",
       fill = "G칠nero") +
  theme_minimal()
```


La mejor opci칩n para visualizar si hay asociaci칩n es que **cada barra de estado civil representa el total y nos muestre el % de cada sexo** en cada una: si fuesen independientes, el reparto por sexo en cada barra deber칤a ser similar. Lo haremos con `position = "fill"`

```{r}
#| code-fold: true
ggplot(datos) +
  geom_bar(aes(x = estado_civil, fill = genero),
           position = "fill", alpha = 0.6) +
  ggthemes::scale_fill_colorblind() +
  labs(x = "Estado civil", y = "Frec. relativas",
       fill = "G칠nero") +
  theme_minimal()
```


```{r}
#| code-fold: true
ggplot(datos) +
  geom_bar(aes(y = estado_civil, fill = genero),
           position = "fill", alpha = 0.6) +
  ggthemes::scale_fill_colorblind() +
  labs(x = "Estado civil", y = "Frec. relativas",
       fill = "G칠nero") +
  theme_minimal()
```

### 游눹 Tu turno

[**Intenta realizar los siguientes ejercicios sin mirar las soluciones**]{style="color:#444442;"}

::: panel-tabset
### [**Ejercicio 1**]{.hl-yellow}

游닇 Calcula las tablas de frecuencias absoluta y relativa con las variables `genero` y `estado_salud`

```{r}
#| code-fold: true
#| eval: false
tabla_freq <- table(datos$genero, datos$estado_salud)
prop.table(tabla_freq)
prop.table(tabla_freq, margin = 1)
prop.table(tabla_freq, margin = 2)
```


### [**Ejercicio 2**]{.hl-yellow}

游닇 Usando la tabla anterior:

* 쯈u칠 porcentaje, de entre las mujeres, tiene un buen estado de salud?

* 쯈u칠 porcentaje, de entre los hombres, tiene un estado de salud regular?

* 쯈u칠 porcentaje de los que tienen estado de salud malo, son mujeres?

```{r}
#| code-fold: true
# De entre las mujeres un 45.28% tiene un buen estado de salud
# De entre los hombres un 34.04% tiene un estado de salud regular
# Un 33.33% de los que tienen un estado de salud malo, son mujeres
```


### [**Ejercicio 3**]{.hl-yellow}

游닇 Realiza ambos contrastes e intenta razonar la respuesta a la pregunta: 쯘st치n estas dos variables asociadas? 쮼xiste alg칰n tipo de dependencia entre ellas? Hazlo considerando $\alpha = 0.05$.

```{r}
#| code-fold: true
#| eval: false
chisq.test(tabla_freq)$p.value
fisher.test(tabla_freq)$p.value

# En ambos casos p-value > alpha: no podemos rechazar la  hip칩tesis nula de independencia: no hay evidencias suficientes CON LA MUESTRA QUE TENEMOS para concluir que haya alguna asociaci칩n
```

### [**Ejercicio 4**]{.hl-yellow}

游닇 Las funciones `chisq.test()` y `fisher.test()` proporcionan un objeto htest que dentro contiene el p-valor (accediendo con `$p.value` dentr de 칠l). 쮺칩mo guardar ambos p-valores en una tabla resumen en tidyverse? Exporta los resultados a un `.csv`



```{r}
#| code-fold: true
resumen_dependencia <-
  datos |> 
  summarise("sig_chisq" = chisq.test(genero, estado_civil)$p.value,
            "sig_fisher" = fisher.test(genero, estado_civil)$p.value)
write_csv(resumen_dependencia, file = "./datos/resumen_dependencia.csv")
```

:::


## 游냒 Caso pr치ctico I: placebo vs f치rmaco 

### Pregunta 1

> Carga el fichero `placebo_medicamento_completo.csv` donde tenemos guardado los niveles de colesterol antes y despu칠s de un tratamiento: a 76 personas se les dio un medicamento para bajarlo y a 24 personas placebo.

```{r}
#| code-fold: true
datos <- read_csv(file = "./datos/placebo_medicamento_completo.csv")
```

```{r}
#| echo: false
#| eval: false
datos <- 
  tibble("id" = 1:100,
         "tratamiento" = c(rep("medicamento", 76), rep("placebo", 24)),
         "colesterol_pre" = rnorm(n = 100, mean = 150, sd = 10),
         "colesterol_post" = 
           colesterol_pre +
           rnorm(n = 100,
                 mean = if_else(tratamiento == "medicamento", -4, 2),
                 sd = 3))
```


### Pregunta 2

> A침ade una nueva variable dicot칩mica a los datos que nos guarde `mejora` si el paciente mejor칩 tras el tratamiento y `no mejora` en caso negativo

```{r}
#| code-fold: true
datos <-
  datos |> 
  mutate("mejora" = if_else(colesterol_post <= colesterol_pre, "mejora",
                            "no mejora"))
```

### Pregunta 3

> Visualiza ambas variables (`mejora` y `tratamiento`) a la vez con un diagrama de barras de manera que podamos observar indicios de una posible independencia o dependencia entre ambas. Echa un vistazo a las diapositivas antes. Hazlo antes a papel y boli si lo necesitas

```{r}
#| code-fold: true
#| eval: false

# as칤 pintar칤amos en cada barra de tratamiento los mejora o no mejora
ggplot(datos) +
  geom_bar(aes(x = tratamiento, fill = mejora), alpha = 0.6) +
  ggthemes::scale_fill_colorblind() +
  theme_minimal()

# pero dado que tienes m치s tratados que del grupo control
# no permite comparar bien as칤 que igualamos las barras
# para que cada barra sea el 100% de su categor칤a
ggplot(datos) +
  geom_bar(aes(x = tratamiento, fill = mejora), alpha = 0.6,
           position = "fill") +
  ggthemes::scale_fill_colorblind() +
  theme_minimal()

# Parece evidente visualmente que hay una diferencia entre mejora y no mejora
# en cada barra
```

### Pregunta 4

> Calcula la tabla de frecuencias absoluta y relativa que consideres necesarias para responder a las siguientes preguntas:

a) 쮺u치ntas personas de las tratadas con medicamento no mejoraron?

b) 쯈u칠 de personas del total del estudio acabaron mejorando habiendo tomando placebo?

c) 쯈u칠 % de personas tom칩 medicamentos entre los que no mejoraron?

d) 쯈u칠 % de personas de los que tomaron medicamento mejoraron?

```{r}
#| code-fold: true
#| eval: false
table(datos$tratamiento, datos$mejora)
prop.table(table(datos$tratamiento, datos$mejora))
prop.table(table(datos$tratamiento, datos$mejora), margin = 1)
prop.table(table(datos$tratamiento, datos$mejora), margin = 2)
# 9 personas de las tratadas con medicamento no mejoraron
# 9% del total de personas mejoraron y tomaron placebo
# 37% de los que no mejoraron hab칤an tomado la medicaci칩n
# 88.1% de los que tomaron medicamento mejoraron
```

### Pregunta 5

> Para confirmar y cuantificar las evidencias que ya tenemos, vamos a realizar un contraste de hip칩tesis. Realiza la prueba de chi-cuadrado e interpreta el resultado con $\alpha = 0.05$.

```{r}
#| code-fold: true
#| eval: false
chisq.test(datos$tratamiento, datos$mejora)
# Dado que p-value = 1.654e-06 << alpha --> debemos rechazar la hip칩tesis nula -->
# hay evidencias suficientes para afirmar que hay relaci칩n de dependencia
```

### Pregunta 6

> Realiza la prueba de chi-cuadrado y Fisher e incluye los p-valores en una tabla resumen haciendo uso de tidyverse. Exporta a un `.csv` dicha tabla resumen

```{r}
#| code-fold: true
resumen_pvalores <-
  datos |> 
  summarise("sig_chisq" = chisq.test(datos$tratamiento, datos$mejora)$p.value,
            "sig_fisher" = fisher.test(datos$tratamiento, datos$mejora)$p.value)
write_csv(resumen_pvalores, file = "./datos/resumen_pvalores.csv")
```

### Pregunta 7

> Realiza la prueba de Fisher y mira la salida completa. Interpreta la salida, no solo del contraste sino de los odd ratio.

```{r}
#| code-fold: true
fisher.test(datos$tratamiento, datos$mejora)

# OR estimado es de 11.95 --> al ser mayor que 1 implica que
# hay una asociaci칩n positiva entre las variables
# hay 12 veces m치s opciones de que te baje el colesterol si tomas el
# medicamento respecto a una posible mejora aleatoria (porque s칤).
```


## 游냒 Caso pr치ctico II: bronquitis y tabaco

```{r}
#| echo: false
#| eval: false
datos <-
  tibble("id" = 1:96,
         "fumador" = c(rep("s칤", 52), rep("no", 44)),
         "estado" = c(rep("bronquitis", 32), rep("sano", 20),
                      rep("bronquitis", 16), rep("sano", 28)))
```

Carga el archivo de datos `fumadores.csv` donde tenemos datos de 96 pacientes sobre s칤 o fuman y quienes han desarrollado o no bronquitis.

```{r}
datos <- read_csv(file = "./datos/fumadores.csv")
datos
```


### Pregunta 1

> Realiza la tabla de contigencia de manera absoluta y relativa y responde a las siguientes preguntas

a) 쮺u치ntas personas fumaoras tienen bronquitis?

b) 쯈u칠 % de los fumadores est치 sano?

c) 쯈u칠 % del total son a la vez no fumadores y enfermos de bronquitis?

d) 쯈u칠 % de los enfermos son fumadores?

```{r}
#| code-fold: true
#| eval: false
table(datos$fumador, datos$estado)
prop.table(table(datos$fumador, datos$estado))
prop.table(table(datos$fumador, datos$estado), margin = 1)
prop.table(table(datos$fumador, datos$estado), margin = 2)
# a) 32 personas
# b) 38.46%
# c) 16%
# d) 61.53%
```

### Pregunta 2

> Visualiza ambas variables a la vez de manera adecuada que nos permita comparar

```{r}
#| code-fold: true
#| eval: false

ggplot(datos) +
  geom_bar(aes(x = fumador, fill = estado), alpha = 0.6, position = "fill") +
  labs(x = "fumador", y = "Frec relativa", fill = "Estado") +
  theme_minimal()
```

### Pregunta 3

> 쮼xisten evidencias en la muestra de una asociaci칩n entre ambas variables?

```{r}
#| code-fold: true
#| eval: false
datos |> 
  summarise("sig_chisq" = chisq.test(datos$fumador, datos$estado)$p.value,
            "sig_fisher" = fisher.test(datos$fumador, datos$estado)$p.value)
# p-valor < alpha --> hay evidencias para rechazar la hip nula
# hay evidencias (no muy fuertes, quiz치s aumentar tama침o muestral?) de
# que las variables son dependientes y existe una asociaci칩n
```


### Pregunta 4

> Si hubiera asociaci칩n, cuantifica la fuerza de dicha asociaci칩n (y el sentido) y calcula el riesgo relativo de los fumadores a contraer bronquitis (respecto a no fumadores)

```{r}
#| code-fold: true
#| eval: false
fisher.test(datos$fumador, datos$estado)
# OR estimado = 0.3611 ==> piensa que tenemos no fumar primero y luego fumar ==>
# 1/0.3611 = 2.769316 > 1 ==> hay una asociaci칩n positiva entre fumar y tener 
# bronquitis 
# La bronquitis en pacientes que fuman es 2.77 veces m치s frecuente
# que en los pacientes que no fuman

# RR ratio
a <- 32  # Expuestos con evento
b <- 16  # Expuestos sin evento
c <- 20  # No expuestos con evento
d <- 28  # No expuestos sin evento

RR <- (a / (a + b)) / (c / (c + d))
# El grupo que fuma tiene un riesgo 1.6 veces mayor de que desarrollar bronquitis en comparaci칩n con el grupo que no fuma.
```


## 游냒 Caso pr치ctico III: salud mental

Esta la base de datos `datos_salud_mental.csv` tenemos informaci칩n recopilada de 100 pacientes que acuden a un centro de salud mental. Se quiere realizar un estudio para ver el **impacto que tienen distintas caracter칤sticas sobre la ansiedad y depresi칩n** en estos 100 pacientes. Los datos incluyen una variedad de variables relacionadas con la salud mental, as칤 como caracter칤sticas demogr치ficas y de estilo de vida.

### Pregunta 1

> Carga la base de datos y normaliza los nombres de las variables

```{r}
#| code-fold: true
datos <-
  read_csv(file = "./datos/datos_salud_mental.csv") |> 
  janitor::clean_names()
```



### Pregunta 2

Las variables son:

* `id`: identificador 칰nico del paciente.
* `edad`: edad del paciente en a침os.
* `Genero`: g칠nero del paciente.
* `ansiedad`: nivel de ansiedad del paciente en una escala del 1 al 10.
* `depresi칩n`: nivel de depresi칩n del paciente en una escala del 1 al 10.
* `sesiones_terapia`: n칰mero de sesiones de terapia asistidas en el 칰ltimo a침o.
* `actividad_fisica`: n칰mero de d칤as a la semana que el paciente realiza actividad f칤sica.
* `horas_sueno`: n칰mero de horas promedio de sue침o por noche.
* `uso_drogas_recreativas`: indicador de si el paciente ha usado drogas recreativas en el 칰ltimo a침o.
* `tipo_drogas`: tipo de drogas que ha consumido el paciente.


> 쮻e qu칠 tipo es cada variable? Convierte las que consideres a cualis nominales y a cualis ordinales, y si hay alguna variable que deba ser l칩gica

```{r}
#| code-fold: true
# id: en realidad esto tendr칤a ser un factor (un texto) ya que no cuenta nada
# Cuantitativas: edad, horas_sueno
# Cualitativas nominales: genero, tipo_drogas
# Cuanitativas discretas: sesiones_terapia y actividad_fisica
# Cuantitativas discretas pero que deber칤amos tratarlas como cualis ordinales
# ya que son escalas: ansiedad, depresi칩n
# Binarias (cualis ordinales muy concretas): uso_drogas_recreativas
datos <-
  datos |> 
  mutate("id" = as.character(id),
         "genero" = factor(genero), "tipo_drogas" = factor(tipo_drogas),
         "ansiedad" = factor(ansiedad, levels = as.character(1:10), ordered = TRUE),
         "depresion" = factor(depresion, levels = as.character(1:10), ordered = TRUE),
         "uso_drogas_recreativas" = (uso_drogas_recreativas == "Si"))
```


### Pregunta 3

> Calcula la tabla de frecuencias absolutas y relativas de g칠nero.

```{r}
#| code-fold: true
tabla_freq_abs <- table(datos$genero)
tabla_freq_rel <- prop.table(tabla_freq_abs)
```


### Pregunta 4

> Calcula la media de las 4 variables cuantitativas que tenemos desagregado por g칠nero. Exporta dicho resumen en un `.csv`

```{r}
#| code-fold: true
resumen <- 
  datos |> 
  drop_na(where(is.numeric)) |> 
  summarise(across(where(is.numeric), mean), .by = genero)
write_csv(resumen, file = "./datos/resumen.csv")
```

### Pregunta 5

> Calcula la tabla de contigencia de las variables ansiedad vs genero. Calcula otra para ansiedad vs depresion. Usa `useNA = "always"` como argumento para incluir los `NA`

```{r}
#| code-fold: true
tabla_freq_genero_ansiedad <- table(datos$genero, datos$ansiedad, useNA = "always")
tabla_freq_depresion_ansiedad <- table(datos$depresion, datos$ansiedad, useNA = "always")
```


### Pregunta 6

> Realiza un gr치fico adecuado para la variable `edad`. Piensa como adaptarlo para tenerlo desagregado por `genero`.

```{r}
#| code-fold: true
#| eval: false
# Densidades
ggplot(datos) +
  geom_density(aes(x = edad), fill = "#459191", alpha = 0.4) +
  labs(x = "Edad (a침os)", y = "Densidad (frec relativa)") +
  theme_minimal()

library(ggridges)
ggplot(datos) +
  geom_density_ridges(aes(x = edad, y = genero, fill = genero), alpha = 0.4) +
  ggthemes::scale_fill_colorblind() +
  labs(x = "Edad (a침os)", y = "Sexo", fill = "G칠nero") +
  theme_minimal()

# Histograma (mala idea con pocos datos)
ggplot(datos) +
  geom_histogram(aes(x = edad), bins = 15, fill = "#459191", alpha = 0.4) +
  labs(x = "Edad (a침os)", y = "Frec absoluta") +
  theme_minimal()
ggplot(datos) +
    geom_histogram(aes(x = edad, fill = genero), bins = 15, alpha = 0.25) +
    labs(x = "Edad (a침os)", y = "Frec absoluta") +
    theme_minimal()

# Boxplot
ggplot(datos) +
  geom_boxplot(aes(y = edad), fill = "#459191", alpha = 0.4,
               outlier.size = 3, outlier.alpha = 0.9,
               outlier.color = "#991293", outlier.shape = 18) +
  labs(y = "Edad") +
  theme_minimal()

ggplot(datos, aes(x = genero, y = edad, fill = genero, color = genero)) +
  geom_boxplot(alpha = 0.4, outlier.size = 3, outlier.alpha = 0.9,
               outlier.color = "#991293", outlier.shape = 18) +
  ggthemes::scale_color_colorblind() +
  ggthemes::scale_fill_colorblind() +
  guides(color = "none") +
  labs(x = "G칠nero", y = "Edad", fill = "G칠nero") +
  theme_minimal()
```

### Pregunta 7 

> Intenta programar el c칩digo que necesitar칤as para obtener los tres gr치fico inferiores. Intenta imitarlos al m치ximo.

```{r}
#| code-fold: true
ggplot(datos) +
  geom_bar(aes(y = ansiedad), fill = "#991293", alpha = 0.5) +
  labs(x = "Frecuencia absoluta", y = "Ansiedad (escala 1 a 10)") +
  theme_minimal()

ggplot(datos) +
  geom_bar(aes(y = ansiedad, fill = genero), alpha = 0.5) +
  ggthemes::scale_fill_colorblind() +
  labs(x = "Frecuencia absoluta", y = "Ansiedad (escala 1 a 10)",
       fill = "G칠nero") +
  theme_minimal()
  
ggplot(datos) +
  geom_bar(aes(y = ansiedad, fill = genero), alpha = 0.5, position = "fill") +
  ggthemes::scale_fill_colorblind() +
  labs(x = "Frecuencia relativa", y = "Ansiedad (escala 1 a 10)",
       fill = "G칠nero") +
  theme_minimal()
```

### Pregunta 8

>  Realiza un gr치fico adecuado para visualizar a la vez depresi칩n y ansiedad.

```{r}
#| code-fold: true
#| eval: false

# f칤jate que aunque sean n칰meros, dado que son variables discretas
# de una escala, no permite una correcta visualizaci칩n un diagrama
# de dispersi칩n ya que hay muchos puntos iguales que se solapan
ggplot(datos) + 
  geom_point(aes(x = depresion, y = ansiedad)) +
  theme_minimal()

# una opci칩n: se ve un patr칩n (tipo "recta ascedente")
ggplot(datos |> count(depresion, ansiedad)) + 
  geom_point(aes(x = depresion, y = ansiedad, color = n, size = n)) +
  scale_color_viridis_c() +
  guides(size = "none") +
  theme_minimal()
```


### Pregunta 9

>  쮼xiste asociaci칩n entre genero y uso de drogas? 쯏 entre depresi칩n y ansiedad? Cuantifica la respuesta todo lo que puedas.

```{r}
#| code-fold: true
resumen_p_valores_1 <-
  datos |> 
  summarise("sig_chisq" = chisq.test(datos$genero, datos$uso_drogas_recreativas)$p.value,
            "sig_fisher" = fisher.test(datos$genero, datos$uso_drogas_recreativas)$p.value)
# p-valores >> alpha --> no evidencias para rechazar la independencia -->
# no hay evidencias para afirmar la dependencia

# con tantas categor칤as Fisher no funciona
chisq.test(datos$depresion, datos$ansiedad)
# p-valores << alpha --> s칤 hay evidencias para rechazar la independencia -->
# s칤 hay evidencias para afirmar la dependencia
```


